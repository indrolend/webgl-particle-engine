<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Hybrid Transition Video (9:16)</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #2c3e50;
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        
        #canvas {
            border: 2px solid #3498db;
            display: block;
            margin: 20px auto;
            background: white;
        }
        
        .controls {
            text-align: center;
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        button {
            padding: 15px 30px;
            font-size: 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            min-width: 200px;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }
        
        .status {
            text-align: center;
            margin: 10px;
            font-size: 16px;
            color: #ecf0f1;
            min-height: 24px;
        }
        
        .status.success {
            color: #2ecc71;
        }
        
        .status.error {
            color: #e74c3c;
        }
        
        .status.recording {
            color: #f39c12;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Export 9:16 Hybrid Transition Video</h1>
    <p style="text-align: center; color: #bdc3c7;">
        Transition: indrolend.png â†’ cover art.jpeg<br>
        Aspect Ratio: 9:16 (Portrait) | Background: White
    </p>
    
    <canvas id="canvas" width="720" height="1280"></canvas>
    
    <div class="controls">
        <button id="startBtn">Start Recording & Transition</button>
        <button id="downloadBtn" disabled>Download Video</button>
    </div>
    
    <div class="status" id="status">Ready to record</div>
    
    <script type="module">
        import { HybridEngine } from './src/HybridEngine.js';
        
        // Constants
        const FINAL_BUFFER_TIME = 500; // Extra time (ms) to ensure recording captures everything
        
        const canvas = document.getElementById('canvas');
        const status = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        
        let engine = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let videoBlob = null;
        
        // Update status message
        function updateStatus(message, type = '') {
            status.textContent = message;
            status.className = 'status ' + type;
        }
        
        // Load images
        async function loadImages() {
            updateStatus('Loading images...');
            
            const image1 = new Image();
            const image2 = new Image();
            
            const loadPromise1 = new Promise((resolve, reject) => {
                image1.onload = resolve;
                image1.onerror = () => reject(new Error('Failed to load indrolend.png'));
            });
            
            const loadPromise2 = new Promise((resolve, reject) => {
                image2.onload = resolve;
                image2.onerror = () => reject(new Error('Failed to load cover art.jpeg'));
            });
            
            image1.src = 'indrolend.png';
            image2.src = 'cover art.jpeg';
            
            await Promise.all([loadPromise1, loadPromise2]);
            
            updateStatus('Images loaded successfully', 'success');
            return { image1, image2 };
        }
        
        // Initialize HybridEngine
        function initializeEngine() {
            updateStatus('Initializing particle engine...');
            
            engine = new HybridEngine(canvas, {
                particleCount: 3000,
                speed: 1.0,
                enableTriangulation: true,
                triangulationMode: 'hybrid',
                gridSize: 8
            });
            
            updateStatus('Engine initialized', 'success');
        }
        
        // Setup MediaRecorder
        function setupRecorder() {
            updateStatus('Setting up video recorder...');
            
            const stream = canvas.captureStream(60); // 60 FPS
            const options = {
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 8000000 // 8 Mbps for high quality
            };
            
            // Fallback to vp8 if vp9 is not supported
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options.mimeType = 'video/webm;codecs=vp8';
            }
            
            // Fallback to default if webm is not supported
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options.mimeType = 'video/webm';
            }
            
            mediaRecorder = new MediaRecorder(stream, options);
            recordedChunks = [];
            
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = () => {
                videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                updateStatus('Recording complete! Click download to save.', 'success');
                downloadBtn.disabled = false;
            };
            
            updateStatus('Recorder ready', 'success');
        }
        
        // Start hybrid transition
        async function startTransition(image1, image2) {
            updateStatus('Starting transition...', 'recording');
            
            // Initialize engine with first image
            engine.initializeFromImage(image1);
            engine.start();
            
            // Wait a bit for the engine to be fully ready
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Configure transition parameters
            const config = {
                explosionIntensity: 150,
                explosionTime: 1000,
                recombinationDuration: 2500,
                blendDuration: 2000,
                recombinationChaos: 0.3,
                vacuumStrength: 0.15,
                particleFadeRate: 0.7,
                staticDisplayDuration: 1000,  // Show source image for 1s
                disintegrationDuration: 1200  // Disintegrate over 1.2s
            };
            
            // Set render mode and start transition
            engine.setRenderMode('hybrid');
            engine.startHybridTransition(image1, image2, config);
            
            // Calculate total duration
            const totalDuration = config.staticDisplayDuration + 
                                  config.disintegrationDuration +
                                  config.explosionTime + 
                                  config.recombinationDuration + 
                                  config.blendDuration + 
                                  1000; // Extra time for final state
            
            updateStatus(`Recording (${Math.round(totalDuration / 1000)}s)...`, 'recording');
            
            // Wait for transition to complete
            await new Promise(resolve => setTimeout(resolve, totalDuration));
            
            updateStatus('Transition complete, finalizing video...', 'recording');
            
            // Give a bit more time to ensure everything is captured
            await new Promise(resolve => setTimeout(resolve, FINAL_BUFFER_TIME));
        }
        
        // Download video
        function downloadVideo() {
            if (!videoBlob) {
                updateStatus('No video to download', 'error');
                return;
            }
            
            const url = URL.createObjectURL(videoBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'hybrid-transition-9x16.webm';
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
                URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }, 100);
            
            updateStatus('Video downloaded!', 'success');
        }
        
        // Main recording workflow
        async function startRecordingAndTransition() {
            try {
                startBtn.disabled = true;
                downloadBtn.disabled = true;
                
                // Load images
                const { image1, image2 } = await loadImages();
                
                // Initialize engine
                initializeEngine();
                
                // Setup recorder
                setupRecorder();
                
                // Start recording
                mediaRecorder.start();
                updateStatus('Recording started...', 'recording');
                
                // Run transition
                await startTransition(image1, image2);
                
                // Stop recording
                mediaRecorder.stop();
                
            } catch (error) {
                console.error('Error during recording:', error);
                updateStatus(`Error: ${error.message}`, 'error');
                startBtn.disabled = false;
            }
        }
        
        // Event listeners
        startBtn.addEventListener('click', startRecordingAndTransition);
        downloadBtn.addEventListener('click', downloadVideo);
        
        // Initial status
        updateStatus('Ready to record. Click "Start Recording & Transition" to begin.');
    </script>
</body>
</html>
